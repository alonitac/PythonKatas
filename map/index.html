<!DOCTYPE html>
<html>

<head>
	<title>Python Katas - Interactive Map</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Leaflet's CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" crossorigin="" />

	<!-- Make sure you put this AFTER Leaflet's CSS -->
	<script src="https://unpkg.com/leaflet/dist/leaflet.js" crossorigin=""></script>

	<!-- Grouping markers to cluster -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" crossorigin="" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" crossorigin="" />
	<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js" crossorigin=""></script>

	<!-- Nested marker cluster -->
	<script src="https://unpkg.com/leaflet.featuregroup.subgroup@latest/dist/leaflet.featuregroup.subgroup.js"></script>

	<!-- Additional icons -->
	<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/fontawesome.min.css" rel="stylesheet" crossorigin="" />
	<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/solid.min.css" rel="stylesheet" crossorigin="" />
	<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/brands.min.css" rel="stylesheet" crossorigin="" />

	<!-- Sidebar -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.css" crossorigin="" />
	<script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js" crossorigin=""></script>

	<!-- Marker editor -->
	<link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" crossorigin="" />
	<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js" crossorigin=""></script>

	<link rel="stylesheet" href="style.css" />
</head>

<body>
	<div class="leaflet-control-layers-base leaflet-control-layers leaflet-control" style="position: absolute; top: 10px; left: 50%; background: white; padding: 10px; z-index: 1000; transform: translate(-50%, 0%);display: flex; justify-content: center; align-items: center;">
		<span>Python Katas for DevOps</span>
	</div>

	<div id="map"></div>
	<script src="common.js" type="text/javascript"></script>
	<script>
		async function init() {
			const response = await fetch('markers.json');
			const data = await response.json();

			const katas_repo = getCookie('python_katas_repo') || 'alonitac/PythonKatas';

			const cached_test_results = getCookie('test_results');
			let cached_test_results_id, markers_ver, cached_results;
			if (cached_test_results) {
				[cached_test_results_id, markers_ver, cached_results] = cached_test_results.split('#');
			}

			let results_str = '';
			const test_results_id = await fetchTestResultsId(katas_repo);
			if (test_results_id) {
  			  console.log('test result id found in internal/test/.test_results_id ' + test_results_id);

			  if (cached_test_results_id === test_results_id && markers_ver === data.version) {
				results_str = cached_results;
			  } else {
				const results = await fetchWorkflowJobs(katas_repo, test_results_id);
				results_str = data.features.map(feature => results.includes(feature.properties.id) ? '1' : '0').join('');
				setCookie('test_results', test_results_id + '#' + data.version + '#' + results_str);
			  }
			}

			data.features.forEach((feature, index) => {
				feature.properties.completed = results_str[index] === '1';
			});

			var interactive_map = new InteractiveMap('map', {
				max_good_zoom: 5,
				max_map_zoom: 7,
				website_source: 'https://github.com/interactive-game-maps/kona',
				website_subdir: 'kona'
			});

			interactive_map.addTileLayer('Ingame map', {
				minNativeZoom: 2,
				maxNativeZoom: 5,
			});

			interactive_map.addInteractiveLayer('markers', data, {
				name: "Python Katas",
				create_checkbox: true,
				create_feature_popup: true,
				sidebar_icon_html: '<i class="fab fa-python"></i>',
				pointToLayer: function (feature, latlng) {
					return L.marker(latlng, {
						icon: Utils.getCustomIcon('fa-brands', feature.properties.completed),
						riseOnHover: true
					});
				}
			});
			interactive_map.finalize();
		}

		init();
	</script>
</body>

</html>
